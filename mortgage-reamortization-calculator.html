<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mortgage Reamortization Calculator | Young Budgeteer</title>

  <!--
  =====================================================================
  WORDPRESS EMBEDDING INSTRUCTIONS
  =====================================================================
  1. Open the page/post where you want this calculator
  2. Add a new block → search for "Custom HTML"
  3. Copy everything BETWEEN the <body> tags (from <div class="yb-calc-wrap">
     down to and including the closing </script> tag)
  4. Paste it into the Custom HTML block
  5. The <style> and <script> tags paste fine in Gutenberg Custom HTML blocks

  If your host strips <script> tags, install the "Code Snippets" plugin
  and add the JS there, or use the "Elementor HTML" widget instead.
  =====================================================================
  -->

  <style>
    /* ── Design tokens ── */
    :root {
      --teal:        #0B7D67;
      --teal-hover:  #0a6e5b;
      --teal-pale:   #e8f5f2;
      --teal-border: #b3d9d2;
      --bg:          #efefef;
      --surface:     #ffffff;
      --border:      #dde0e3;
      --text:        #1a1a1a;
      --text-mid:    #555;
      --text-muted:  #888;
      --green:       #2e7d32;
      --green-pale:  #e8f5e9;
      --red:         #c62828;
      --radius:      10px;
      --shadow:      0 2px 10px rgba(0,0,0,0.08);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px 16px 48px;
      line-height: 1.5;
    }

    .yb-calc-wrap { max-width: 920px; margin: 0 auto; }

    /* ── Header ── */
    .calc-header { text-align: center; margin-bottom: 32px; }
    .calc-header h1 {
      font-size: clamp(1.4rem, 4vw, 2rem);
      font-weight: 700;
      color: var(--teal);
      margin-bottom: 10px;
    }
    .calc-header p { font-size: 1rem; color: var(--text-mid); max-width: 600px; margin: 0 auto; }

    /* ── Card ── */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text);
      padding-bottom: 14px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--teal-pale);
    }

    /* ── Section labels inside card ── */
    .section-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-mid);
      margin-bottom: 16px;
    }
    .optional-tag {
      font-size: 0.71rem;
      font-weight: 600;
      text-transform: none;
      letter-spacing: 0;
      color: var(--text-muted);
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .section-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 22px 0;
    }

    /* ── Input grid ── */
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 560px) { .input-grid { grid-template-columns: 1fr; } }

    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-size: 0.875rem; font-weight: 600; color: var(--text); }
    .input-group .hint { font-size: 0.78rem; color: var(--text-muted); margin-top: 3px; }

    /* Input with prefix/suffix */
    .field-wrap {
      display: flex;
      align-items: stretch;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: var(--surface);
    }
    .field-wrap:focus-within {
      border-color: var(--teal);
      box-shadow: 0 0 0 3px rgba(11,125,103,0.12);
    }
    .field-affix {
      display: flex;
      align-items: center;
      padding: 0 11px;
      background: #f5f6f7;
      color: var(--text-mid);
      font-size: 0.9rem;
      font-weight: 600;
      border-right: 1.5px solid var(--border);
      user-select: none;
      white-space: nowrap;
    }
    .field-affix.suffix { border-right: none; border-left: 1.5px solid var(--border); }
    .field-wrap input {
      flex: 1;
      min-width: 0;
      padding: 11px 12px;
      border: none;
      outline: none;
      font-size: 1rem;
      color: var(--text);
      background: transparent;
      -moz-appearance: textfield;
    }
    .field-wrap input::-webkit-outer-spin-button,
    .field-wrap input::-webkit-inner-spin-button { -webkit-appearance: none; }

    .term-row { display: flex; gap: 10px; }
    .term-row .field-wrap { flex: 1; }

    /* ── PMI section ── */
    .pmi-toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      cursor: pointer;
      user-select: none;
    }
    .pmi-toggle-row input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: var(--teal);
      cursor: pointer;
    }
    .pmi-toggle-row span { font-size: 0.9rem; font-weight: 600; color: var(--teal); }
    .pmi-fields {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--teal-border);
    }
    .pmi-fields.open { display: grid; }
    @media (max-width: 560px) { .pmi-fields { grid-template-columns: 1fr; } }

    /* ── Buttons ── */
    .btn-primary {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 24px;
      background: var(--teal);
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-primary:hover { background: var(--teal-hover); }
    .btn-primary:active { transform: scale(0.99); }

    .btn-ghost {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 1.5px solid var(--teal);
      color: var(--teal);
      background: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-ghost:hover { background: var(--teal-pale); }

    /* Download button */
    .btn-dl {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 7px 14px;
      border: 1.5px solid var(--border);
      color: var(--text-mid);
      background: var(--surface);
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .btn-dl:hover { background: #f0f0f0; border-color: #bbb; }

    /* Table actions row */
    .table-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ── Error message ── */
    .error-msg {
      display: none;
      color: var(--red);
      font-size: 0.85rem;
      margin-top: 10px;
      padding: 8px 12px;
      background: #fff0f0;
      border-radius: 5px;
      border-left: 3px solid var(--red);
    }

    /* ── Results section ── */
    .results-wrap { display: none; }
    .results-wrap.visible { display: block; animation: slideUp 0.35s ease; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── Metric cards ── */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }
    @media (max-width: 680px) { .metrics-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 360px) { .metrics-grid { grid-template-columns: 1fr; } }

    .metric-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 16px;
      text-align: center;
    }
    .metric-card.primary { background: var(--teal); color: #fff; }
    .metric-card.savings { background: var(--green-pale); border: 1.5px solid #a5d6a7; }
    .metric-lbl {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .metric-card.primary .metric-lbl { color: rgba(255,255,255,0.75); }
    .metric-card.savings .metric-lbl { color: var(--green); }
    .metric-val { font-size: 1.45rem; font-weight: 800; color: var(--text); line-height: 1.2; }
    .metric-card.primary .metric-val { color: #fff; }
    .metric-card.savings .metric-val { color: var(--green); }
    .metric-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .metric-card.primary .metric-sub { color: rgba(255,255,255,0.65); }
    .metric-card.savings .metric-sub { color: var(--green); opacity: 0.8; }

    /* PMI badge */
    .pmi-badge {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin-bottom: 20px;
      background: var(--green-pale);
      border: 1.5px solid #a5d6a7;
      border-radius: var(--radius);
      color: var(--green);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .pmi-badge.show { display: flex; }
    .pmi-badge .badge-icon { font-size: 1.3rem; }

    /* ── Comparison table ── */
    .compare-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
    .compare-table thead th {
      padding: 10px 14px;
      background: var(--teal-pale);
      color: var(--teal);
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      text-align: right;
    }
    .compare-table thead th:first-child { text-align: left; }
    .compare-table tbody td {
      padding: 11px 14px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      text-align: right;
    }
    .compare-table tbody td:first-child { text-align: left; font-weight: 600; color: var(--text-mid); }
    .compare-table tbody tr:last-child td { border-bottom: none; }
    .compare-table .col-after { color: var(--teal); font-weight: 700; }
    .compare-table .col-save { color: var(--green); font-weight: 700; }

    /* ── Chart ── */
    .chart-wrap { position: relative; height: 220px; }
    canvas { display: block; max-width: 100%; }
    .chart-legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 12px;
      font-size: 0.82rem;
      color: var(--text-mid);
    }
    .legend-dot {
      display: inline-block;
      width: 24px;
      height: 3px;
      border-radius: 2px;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* ── Amortization tables (shared styles) ── */
    .amort-wrap {
      display: none;
      overflow-x: auto;
      margin-top: 16px;
    }
    .amort-wrap.open { display: block; }

    /* Monthly table: scrollable with sticky header */
    .monthly-scroll {
      display: none;
      max-height: 460px;
      overflow-y: auto;
      overflow-x: auto;
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }
    .monthly-scroll.open { display: block; }

    .amort-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      min-width: 480px;
    }
    .amort-table thead th {
      padding: 9px 10px;
      background: var(--teal);
      color: #fff;
      font-weight: 600;
      font-size: 0.74rem;
      text-align: right;
      white-space: nowrap;
    }
    .amort-table thead th:first-child { text-align: left; }
    /* Sticky header for monthly scroll */
    .monthly-scroll .amort-table thead th { position: sticky; top: 0; z-index: 2; }

    .amort-table tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: right;
      white-space: nowrap;
    }
    .amort-table tbody td:first-child { text-align: left; font-weight: 600; }
    .amort-table tbody tr:nth-child(even) { background: #f8f9fa; }
    .amort-table .col-saved { color: var(--green); font-weight: 700; }
    .amort-table .col-equity { color: var(--teal); font-weight: 600; }

    /* Table note */
    .table-note {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    /* ── Disclaimer ── */
    .disclaimer {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 4px;
      padding: 0 8px;
    }
  </style>
</head>
<body>

<div class="yb-calc-wrap">

  <!-- Header -->
  <div class="calc-header">
    <h1>Mortgage Reamortization Calculator</h1>
    <p>See exactly how much a lump-sum principal payment lowers your monthly payment and total interest — without refinancing, a credit check, or closing costs.</p>
  </div>

  <!-- ── Input card ── -->
  <div class="card">
    <div class="card-title">Loan Details</div>

    <!-- Original Loan (optional) -->
    <div class="section-label">
      Original Loan
      <span class="optional-tag">optional — enter both fields for accurate current payment display</span>
    </div>
    <div class="input-grid">
      <div class="input-group">
        <label for="fc-orig-balance">Original Loan Amount</label>
        <div class="field-wrap">
          <span class="field-affix">$</span>
          <input type="number" id="fc-orig-balance" placeholder="350,000" min="1" step="any">
        </div>
        <span class="hint">The amount you originally borrowed</span>
      </div>
      <div class="input-group">
        <label>Original Loan Term</label>
        <div class="term-row">
          <div class="field-wrap">
            <input type="number" id="fc-orig-years" placeholder="30" min="0" max="40" step="1">
            <span class="field-affix suffix">yrs</span>
          </div>
          <div class="field-wrap">
            <input type="number" id="fc-orig-mo" placeholder="0" min="0" max="11" step="1">
            <span class="field-affix suffix">mo</span>
          </div>
        </div>
        <span class="hint">Your loan's original length</span>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Current Loan & Recast -->
    <div class="section-label">Current Loan &amp; Recast</div>
    <div class="input-grid">

      <div class="input-group">
        <label for="fc-balance">Current Remaining Balance</label>
        <div class="field-wrap">
          <span class="field-affix">$</span>
          <input type="number" id="fc-balance" placeholder="317,000" min="1" step="any">
        </div>
        <span class="hint">Your remaining principal balance today</span>
      </div>

      <div class="input-group">
        <label for="fc-rate">Annual Interest Rate</label>
        <div class="field-wrap">
          <input type="number" id="fc-rate" placeholder="3.25" min="0.01" max="30" step="0.01">
          <span class="field-affix suffix">%</span>
        </div>
        <span class="hint">Your current mortgage rate (not APR)</span>
      </div>

      <div class="input-group">
        <label>Remaining Term</label>
        <div class="term-row">
          <div class="field-wrap">
            <input type="number" id="fc-years" placeholder="27" min="0" max="40" step="1">
            <span class="field-affix suffix">yrs</span>
          </div>
          <div class="field-wrap">
            <input type="number" id="fc-months" placeholder="0" min="0" max="11" step="1">
            <span class="field-affix suffix">mo</span>
          </div>
        </div>
        <span class="hint">Years and months left on your loan</span>
      </div>

      <div class="input-group">
        <label for="fc-lump">Lump-Sum Payment</label>
        <div class="field-wrap">
          <span class="field-affix">$</span>
          <input type="number" id="fc-lump" placeholder="55,000" min="1" step="any">
        </div>
        <span class="hint">Extra principal you plan to pay at recast</span>
      </div>

    </div><!-- /input-grid -->

    <!-- PMI optional section -->
    <div style="margin-top: 22px; padding-top: 18px; border-top: 1px solid var(--border);">
      <label class="pmi-toggle-row">
        <input type="checkbox" id="fc-pmi-toggle" onchange="togglePMI()">
        <span>&#43; Include PMI savings (optional)</span>
      </label>
      <div class="pmi-fields" id="pmi-fields">
        <div class="input-group">
          <label for="fc-home-val">Current Home Value</label>
          <div class="field-wrap">
            <span class="field-affix">$</span>
            <input type="number" id="fc-home-val" placeholder="372,000" min="1" step="any">
          </div>
          <span class="hint">Used to calculate loan-to-value ratio</span>
        </div>
        <div class="input-group">
          <label for="fc-pmi">Monthly PMI Amount</label>
          <div class="field-wrap">
            <span class="field-affix">$</span>
            <input type="number" id="fc-pmi" placeholder="88" min="0" step="any">
          </div>
          <span class="hint">Your current monthly PMI charge</span>
        </div>
      </div>
    </div>

    <button class="btn-primary" onclick="runCalc()">Calculate My Savings</button>
    <div class="error-msg" id="fc-error"></div>
  </div><!-- /card -->


  <!-- ── Results ── -->
  <div class="results-wrap" id="results-wrap">

    <!-- PMI eliminated badge -->
    <div class="pmi-badge" id="pmi-badge">
      <span class="badge-icon">&#10003;</span>
      <span>PMI eliminated after recast — saving an additional <strong id="pmi-badge-amount"></strong>/month!</span>
    </div>

    <!-- Metric cards -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-lbl">Current Payment</div>
        <div class="metric-val" id="m-current">—</div>
        <div class="metric-sub">/ month</div>
      </div>
      <div class="metric-card primary">
        <div class="metric-lbl">New Payment</div>
        <div class="metric-val" id="m-new">—</div>
        <div class="metric-sub">/ month after recast</div>
      </div>
      <div class="metric-card savings">
        <div class="metric-lbl">Monthly Savings</div>
        <div class="metric-val" id="m-monthly">—</div>
        <div class="metric-sub">saved every month</div>
      </div>
      <div class="metric-card savings">
        <div class="metric-lbl">Total Interest Saved</div>
        <div class="metric-val" id="m-interest">—</div>
        <div class="metric-sub">over remaining term</div>
      </div>
    </div>

    <!-- Before / After comparison -->
    <div class="card">
      <div class="card-title">Before vs. After Comparison</div>
      <table class="compare-table">
        <thead>
          <tr>
            <th>Detail</th>
            <th>Before Recast</th>
            <th>After Recast</th>
            <th>Savings</th>
          </tr>
        </thead>
        <tbody id="compare-body"></tbody>
      </table>
    </div>

    <!-- Balance chart -->
    <div class="card">
      <div class="card-title">Remaining Balance Over Time</div>
      <div class="chart-wrap">
        <canvas id="balance-chart"></canvas>
      </div>
      <div class="chart-legend">
        <span><span class="legend-dot" style="background:#bbb;"></span>Before recast</span>
        <span><span class="legend-dot" style="background:var(--teal);"></span>After recast</span>
      </div>
    </div>

    <!-- Year-by-year schedule -->
    <div class="card">
      <div class="card-title">Year-by-Year Schedule</div>
      <div class="table-actions">
        <button class="btn-ghost" id="amort-toggle-btn" onclick="toggleAmort()">&#9654; Show full schedule</button>
        <button class="btn-dl" onclick="downloadYearlyCSV()">&#8595; Download CSV</button>
      </div>
      <div class="amort-wrap" id="amort-wrap">
        <table class="amort-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Before: Balance</th>
              <th>Before: Interest</th>
              <th>After: Balance</th>
              <th>After: Interest</th>
              <th>Interest Saved</th>
            </tr>
          </thead>
          <tbody id="amort-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Month-by-month schedule -->
    <div class="card">
      <div class="card-title">
        Month-by-Month Schedule
        <span style="font-size:0.85rem; font-weight:400; color:var(--text-mid);">— After Recast</span>
      </div>
      <div class="table-actions">
        <button class="btn-ghost" id="monthly-toggle-btn" onclick="toggleMonthly()">&#9654; Show schedule</button>
        <button class="btn-dl" onclick="downloadMonthlyCSV('before')">&#8595; Before Recast CSV</button>
        <button class="btn-dl" onclick="downloadMonthlyCSV('after')">&#8595; After Recast CSV</button>
      </div>
      <p class="table-note" id="monthly-note"></p>
      <div class="monthly-scroll" id="monthly-scroll">
        <table class="amort-table">
          <thead id="monthly-head"></thead>
          <tbody id="monthly-body"></tbody>
        </table>
      </div>
    </div>

    <p class="disclaimer">
      * Results are estimates for informational purposes. Reamortization policies, fees, and eligibility vary by lender —
      typically requires a lump-sum payment (often ≥$5,000–10,000) and a small processing fee ($150–500).
      Consult your lender before making any financial decisions.
    </p>

  </div><!-- /results-wrap -->

</div><!-- /yb-calc-wrap -->


<script>
  /* ── Helpers ── */
  const $ = id => document.getElementById(id);
  const fmtUSD = n => '$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const fmtShort = n => {
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'k';
    return '$' + n.toFixed(0);
  };

  /* Shared calculation state for CSV downloads */
  let _state = null;

  /* ── Core finance math ── */
  function calcPayment(principal, annualRate, months) {
    if (annualRate === 0) return principal / months;
    const r = annualRate / 100 / 12;
    return principal * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1);
  }

  function calcTotalInterest(principal, annualRate, months) {
    return calcPayment(principal, annualRate, months) * months - principal;
  }

  /* Returns array of {year, endBalance, yearInterest} */
  function buildYearlySchedule(principal, annualRate, months) {
    const r = annualRate / 100 / 12;
    const pmt = calcPayment(principal, annualRate, months);
    let bal = principal, yearInterest = 0;
    const rows = [];
    for (let m = 1; m <= months; m++) {
      const interest = bal * r;
      bal -= (pmt - interest);
      yearInterest += interest;
      if (bal < 0) bal = 0;
      if (m % 12 === 0 || m === months) {
        rows.push({ year: Math.ceil(m / 12), endBalance: bal, yearInterest });
        yearInterest = 0;
      }
    }
    return rows;
  }

  /*
   * Returns array of monthly rows:
   * { month, payment, principal, interest, balance, cumPrin, cumInt, cumPandI }
   */
  function buildMonthlyScheduleData(principal, annualRate, months) {
    const r = annualRate / 100 / 12;
    const pmt = calcPayment(principal, annualRate, months);
    let bal = principal, cumPrin = 0, cumInt = 0;
    const rows = [];
    for (let m = 1; m <= months; m++) {
      const interest = bal * r;
      const principalPaid = pmt - interest;
      bal = Math.max(bal - principalPaid, 0);
      cumPrin += principalPaid;
      cumInt  += interest;
      rows.push({
        month: m,
        payment: pmt,
        principal: principalPaid,
        interest,
        balance: bal,
        cumPrin,
        cumInt,
        cumPandI: cumPrin + cumInt
      });
    }
    return rows;
  }

  /* Returns array of monthly ending balances (used for chart) */
  function buildMonthlyBalances(principal, annualRate, months) {
    const r = annualRate / 100 / 12;
    const pmt = calcPayment(principal, annualRate, months);
    let bal = principal;
    const arr = [principal];
    for (let m = 1; m <= months; m++) {
      bal -= (pmt - bal * r);
      arr.push(Math.max(bal, 0));
    }
    return arr;
  }

  /* ── Toggle helpers ── */
  function togglePMI() {
    $('pmi-fields').classList.toggle('open', $('fc-pmi-toggle').checked);
  }

  function toggleAmort() {
    const wrap = $('amort-wrap'), btn = $('amort-toggle-btn');
    const open = wrap.classList.toggle('open');
    btn.textContent = open ? '▼ Hide schedule' : '▶ Show full schedule';
  }

  function toggleMonthly() {
    const wrap = $('monthly-scroll'), btn = $('monthly-toggle-btn');
    const open = wrap.classList.toggle('open');
    btn.textContent = open ? '▼ Hide schedule' : '▶ Show schedule';
  }

  /* ── CSV download ── */
  function downloadCSV(headers, rows, filename) {
    const BOM = '\uFEFF'; // UTF-8 BOM so Excel opens correctly
    const csv = [headers, ...rows]
      .map(r => r.map(c => '"' + String(c ?? '').replace(/"/g, '""') + '"').join(','))
      .join('\r\n');
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
  }

  function downloadYearlyCSV() {
    if (!_state) return;
    const { balance, rate, months, newBalance } = _state;
    const before = buildYearlySchedule(balance,    rate, months);
    const after  = buildYearlySchedule(newBalance, rate, months);
    const headers = ['Year', 'Before: Balance', 'Before: Interest Paid', 'After: Balance', 'After: Interest Paid', 'Interest Saved'];
    const rows = before.map((b, i) => {
      const a = after[i];
      return [b.year, b.endBalance.toFixed(2), b.yearInterest.toFixed(2),
              a ? a.endBalance.toFixed(2) : '',
              a ? a.yearInterest.toFixed(2) : '',
              a ? (b.yearInterest - a.yearInterest).toFixed(2) : ''];
    });
    downloadCSV(headers, rows, 'reamortization-yearly-schedule.csv');
  }

  function downloadMonthlyCSV(scenario) {
    if (!_state) return;
    const { balance, rate, months, newBalance, lump, origBalance } = _state;
    const principal  = scenario === 'before' ? balance : newBalance;
    const data       = buildMonthlyScheduleData(principal, rate, months);
    const hasOrigBal = origBalance != null && origBalance > 0;

    /* Equity column label and calculation */
    const equityLabel = hasOrigBal
      ? 'Total Equity (Orig. Balance - Remaining Balance)'
      : (scenario === 'after'
          ? 'Equity Gain Since Recast (Lump Sum + Cum. Principal)'
          : 'Cumulative Principal Paid');

    const headers = [
      'Month', 'Principal', 'Interest', 'P+I Payment',
      'Remaining Balance', 'Cum. Principal', 'Cum. Interest',
      'Cum. P+I', equityLabel
    ];

    const rows = data.map(d => {
      let equity;
      if (hasOrigBal) {
        equity = origBalance - d.balance;
      } else if (scenario === 'after') {
        equity = lump + d.cumPrin;
      } else {
        equity = d.cumPrin;
      }
      return [d.month, d.principal.toFixed(2), d.interest.toFixed(2),
              d.payment.toFixed(2), d.balance.toFixed(2),
              d.cumPrin.toFixed(2), d.cumInt.toFixed(2),
              d.cumPandI.toFixed(2), equity.toFixed(2)];
    });

    downloadCSV(headers, rows, `reamortization-${scenario}-monthly.csv`);
  }

  /* ── Main calculation ── */
  function runCalc() {
    /* Parse original loan fields (optional) */
    const origBalance = parseFloat($('fc-orig-balance').value) || null;
    const origY  = parseInt($('fc-orig-years').value) || 0;
    const origMo = parseInt($('fc-orig-mo').value)    || 0;
    const origMonths = origY * 12 + origMo;

    /* Parse required fields */
    const balance = parseFloat($('fc-balance').value);
    const rate    = parseFloat($('fc-rate').value);
    const termY   = parseInt($('fc-years').value)  || 0;
    const termMo  = parseInt($('fc-months').value) || 0;
    const lump    = parseFloat($('fc-lump').value);
    const usePMI  = $('fc-pmi-toggle').checked;
    const homeVal = usePMI ? parseFloat($('fc-home-val').value) || 0 : 0;
    const pmiAmt  = usePMI ? parseFloat($('fc-pmi').value)     || 0 : 0;

    const errEl = $('fc-error');
    errEl.style.display = 'none';

    const fail = msg => { errEl.textContent = msg; errEl.style.display = 'block'; };
    if (!balance || balance <= 0)    return fail('Please enter your current remaining balance.');
    if (!rate    || rate    <= 0)    return fail('Please enter your interest rate.');
    if (termY === 0 && termMo === 0) return fail('Please enter your remaining loan term.');
    if (!lump    || lump    <= 0)    return fail('Please enter the lump-sum payment amount.');
    if (lump >= balance)             return fail('The lump-sum payment cannot exceed your current loan balance.');

    const months     = termY * 12 + termMo;
    const newBalance = balance - lump;

    /*
     * Current Payment:
     * Use original balance + original term if both are provided —
     * this matches the payment on the borrower's monthly statement.
     * Otherwise fall back to the current remaining balance + remaining term.
     */
    const pmtCurrent = (origBalance && origMonths > 0)
      ? calcPayment(origBalance, rate, origMonths)
      : calcPayment(balance, rate, months);

    const pmtAfter = calcPayment(newBalance, rate, months);
    const pmtDiff  = pmtCurrent - pmtAfter;

    const intBefore = calcTotalInterest(balance,    rate, months);
    const intAfter  = calcTotalInterest(newBalance, rate, months);
    const intSaved  = intBefore - intAfter;

    /* PMI check */
    let pmiEliminated = false, pmiMonthly = 0, pmiTotal = 0;
    if (usePMI && homeVal > 0) {
      if (balance / homeVal > 0.80 && newBalance / homeVal <= 0.80) {
        pmiEliminated = true;
        pmiMonthly = pmiAmt;
        pmiTotal   = pmiAmt * months;
      }
    }

    /* Save state for CSV downloads */
    _state = { balance, rate, months, newBalance, lump, origBalance,
               pmtCurrent, pmtAfter, pmtDiff, intBefore, intAfter, intSaved,
               pmiEliminated, pmiMonthly, pmiTotal };

    /* ── Metric cards ── */
    $('m-current').textContent  = fmtUSD(pmtCurrent);
    $('m-new').textContent      = fmtUSD(pmtAfter);
    $('m-monthly').textContent  = fmtUSD(pmtDiff  + pmiMonthly);
    $('m-interest').textContent = fmtUSD(intSaved + pmiTotal);

    /* ── PMI badge ── */
    if (pmiEliminated) {
      $('pmi-badge-amount').textContent = fmtUSD(pmiMonthly);
      $('pmi-badge').classList.add('show');
    } else {
      $('pmi-badge').classList.remove('show');
    }

    /* ── Comparison table ── */
    const cmpRows = [
      ['Loan Balance',    fmtUSD(balance),           fmtUSD(newBalance),              '−' + fmtUSD(lump)],
      ['Monthly Payment', fmtUSD(pmtCurrent),        fmtUSD(pmtAfter),                '−' + fmtUSD(pmtDiff)],
      ['Annual Payment',  fmtUSD(pmtCurrent * 12),   fmtUSD(pmtAfter * 12),           '−' + fmtUSD(pmtDiff * 12)],
      ['Total Interest',  fmtUSD(intBefore),         fmtUSD(intAfter),                '−' + fmtUSD(intSaved)],
      ['Total Cost',      fmtUSD(pmtCurrent * months), fmtUSD(lump + pmtAfter * months), '−' + fmtUSD(intSaved)],
    ];
    if (pmiEliminated) {
      cmpRows.push(['PMI Savings', fmtUSD(pmiAmt) + '/mo', '$0/mo', '−' + fmtUSD(pmiTotal)]);
    }
    $('compare-body').innerHTML = cmpRows.map(r =>
      `<tr><td>${r[0]}</td><td>${r[1]}</td><td class="col-after">${r[2]}</td><td class="col-save">${r[3]}</td></tr>`
    ).join('');

    /* ── Year-by-year table ── */
    const sBefore = buildYearlySchedule(balance,    rate, months);
    const sAfter  = buildYearlySchedule(newBalance, rate, months);
    $('amort-body').innerHTML = sBefore.map((b, i) => {
      const a = sAfter[i];
      const saved = a ? b.yearInterest - a.yearInterest : 0;
      return `<tr>
        <td>Year ${b.year}</td>
        <td>${fmtUSD(b.endBalance)}</td>
        <td>${fmtUSD(b.yearInterest)}</td>
        <td>${a ? fmtUSD(a.endBalance) : '—'}</td>
        <td>${a ? fmtUSD(a.yearInterest) : '—'}</td>
        <td class="col-saved">${a ? fmtUSD(saved) : '—'}</td>
      </tr>`;
    }).join('');

    /* ── Month-by-month table (after recast) ── */
    renderMonthlyTable(newBalance, rate, months, origBalance, lump);

    /* ── Show results ── */
    $('results-wrap').classList.add('visible');
    $('results-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });

    setTimeout(() => {
      drawChart(months,
        buildMonthlyBalances(balance,    rate, months),
        buildMonthlyBalances(newBalance, rate, months));
    }, 60);
  }

  /* ── Render month-by-month HTML table ── */
  function renderMonthlyTable(principal, annualRate, months, origBalance, lump) {
    const hasOrigBal = origBalance != null && origBalance > 0;

    /* Dynamic equity column header */
    const equityHead = hasOrigBal
      ? 'Total Equity<br><small style="font-weight:400;">(orig. bal. − remaining)</small>'
      : 'Equity Gain<br><small style="font-weight:400;">(lump + cum. principal)</small>';

    $('monthly-head').innerHTML = `<tr>
      <th>Month</th>
      <th>Principal</th>
      <th>Interest</th>
      <th>P+I Payment</th>
      <th>Remaining Balance</th>
      <th>Cum. Principal</th>
      <th>Cum. Interest</th>
      <th>Cum. P+I</th>
      <th>${equityHead}</th>
    </tr>`;

    const data = buildMonthlyScheduleData(principal, annualRate, months);

    $('monthly-body').innerHTML = data.map(d => {
      const equity = hasOrigBal
        ? origBalance - d.balance
        : lump + d.cumPrin;
      return `<tr>
        <td>${d.month}</td>
        <td>${fmtUSD(d.principal)}</td>
        <td>${fmtUSD(d.interest)}</td>
        <td>${fmtUSD(d.payment)}</td>
        <td>${fmtUSD(d.balance)}</td>
        <td>${fmtUSD(d.cumPrin)}</td>
        <td>${fmtUSD(d.cumInt)}</td>
        <td>${fmtUSD(d.cumPandI)}</td>
        <td class="col-equity">${fmtUSD(equity)}</td>
      </tr>`;
    }).join('');

    const yrs = Math.floor(months / 12);
    const mo  = months % 12;
    const termStr = yrs > 0 ? yrs + ' yr' + (yrs > 1 ? 's' : '') + (mo > 0 ? ' ' + mo + ' mo' : '') : mo + ' months';
    $('monthly-note').textContent =
      `${months} rows (${termStr}). HTML table shows after-recast schedule. Use "Before Recast CSV" or "After Recast CSV" buttons to download either scenario.`;
  }

  /* ── Canvas balance chart ── */
  function drawChart(totalMonths, before, after) {
    const canvas = $('balance-chart');
    const ctx    = canvas.getContext('2d');
    const dpr    = window.devicePixelRatio || 1;
    const cW     = canvas.parentElement.clientWidth;
    const cH     = 220;

    canvas.width  = cW * dpr; canvas.height = cH * dpr;
    canvas.style.width = cW + 'px'; canvas.style.height = cH + 'px';
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, cW, cH);

    const pad  = { top: 16, right: 16, bottom: 36, left: 68 };
    const w    = cW - pad.left - pad.right;
    const h    = cH - pad.top  - pad.bottom;
    const maxY = before[0];

    /* Grid + Y labels */
    ctx.strokeStyle = '#e8eaed'; ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + h * i / 4;
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + w, y); ctx.stroke();
      ctx.fillStyle = '#999'; ctx.font = '11px -apple-system, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(fmtShort(maxY * (1 - i / 4)), pad.left - 6, y + 4);
    }

    /* X labels */
    const years = Math.ceil(totalMonths / 12);
    const xStep = years <= 10 ? 1 : years <= 20 ? 2 : 5;
    ctx.fillStyle = '#999'; ctx.font = '11px -apple-system, sans-serif'; ctx.textAlign = 'center';
    for (let yr = 0; yr <= years; yr += xStep) {
      ctx.fillText('Yr ' + yr, pad.left + (yr / years) * w, cH - pad.bottom + 16);
    }

    function drawLine(arr, color, dashed) {
      ctx.strokeStyle = color; ctx.lineWidth = 2.5;
      ctx.setLineDash(dashed ? [7, 4] : []);
      ctx.beginPath();
      for (let i = 0; i < arr.length; i++) {
        const x = pad.left + (i / totalMonths) * w;
        const y = pad.top  + (1 - arr[i] / maxY) * h;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke(); ctx.setLineDash([]);
    }

    drawLine(before, '#c0c0c0', true);
    drawLine(after,  '#0B7D67', false);
  }

  /* ── Redraw chart on resize ── */
  let _rt;
  window.addEventListener('resize', () => {
    clearTimeout(_rt);
    _rt = setTimeout(() => {
      if (!$('results-wrap').classList.contains('visible')) return;
      const b = parseFloat($('fc-balance').value);
      const r = parseFloat($('fc-rate').value);
      const m = (parseInt($('fc-years').value)||0)*12 + (parseInt($('fc-months').value)||0);
      const l = parseFloat($('fc-lump').value);
      if (b && r && m && l && l < b) {
        drawChart(m, buildMonthlyBalances(b, r, m), buildMonthlyBalances(b - l, r, m));
      }
    }, 200);
  });

  /* ── Enter key triggers calculation ── */
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.closest('.yb-calc-wrap')) runCalc();
  });
</script>

</body>
</html>
